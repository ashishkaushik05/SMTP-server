# SMTP Server Setup Guide for leazzy.in

This guide will help you set up your SMTP server for the domain leazzy.in.

## Local Development Setup

1. Make sure you have Node.js 18.x or higher installed.

2. Clone the repository and install dependencies:
```bash
git clone <repository-url>
cd smtp-server
npm install
```

3. The .env file is already configured for leazzy.in. You only need to update the AWS EC2 IP address when you have it.

4. Generate DKIM keys:
```bash
npm run generate-dkim
```

5. Start the server in development mode:
```bash
npm run dev
```

6. Test the server:
```bash
npm test
```

## MongoDB Setup

The SMTP server uses MongoDB to store emails. You need to provide a MongoDB connection string in the .env file:

```
MONGODB_URI=mongodb+srv://your-username:your-password@your-cluster.mongodb.net/smtp_server?retryWrites=true&w=majority
MONGODB_DB_NAME=smtp_server
```

You can use MongoDB Atlas (https://www.mongodb.com/cloud/atlas) to create a free MongoDB cluster.

## Automated Deployment

The project includes an automated deployment script that handles the entire setup process:

1. Update the configuration variables in the `deploy.sh` script:
   - `EC2_IP`: Your AWS EC2 instance IP address
   - `EC2_USER`: The username for your EC2 instance (usually "ubuntu")
   - `EC2_KEY_PATH`: The path to your EC2 key file
   - `MONGODB_URI`: Your MongoDB connection string
   - `MONGODB_DB_NAME`: Your MongoDB database name
   - `SMTP_USER`: Your SMTP username
   - `SMTP_PASS`: Your SMTP password

2. Run the deployment script:
```bash
./deploy.sh
```

The script will:
- Check for required tools
- Generate DKIM keys
- Update the .env file with your configuration
- Generate DNS records
- Create a deployment package
- Deploy to your EC2 instance
- Set up SSL certificates
- Start the server with PM2

## Manual AWS EC2 Setup

If you prefer to set up the EC2 instance manually:

1. Launch an Ubuntu EC2 instance on AWS.

2. Configure the security group to allow inbound traffic on port 25 (SMTP).

3. SSH into your EC2 instance:
```bash
ssh -i your-key.pem ubuntu@your-ec2-ip
```

4. Copy the setup script to your EC2 instance:
```bash
scp -i your-key.pem scripts/setup-aws-ec2.sh ubuntu@your-ec2-ip:~/
```

5. Run the setup script:
```bash
chmod +x setup-aws-ec2.sh
./setup-aws-ec2.sh
```

6. Update your .env file with the AWS EC2 IP address:
```
AWS_EC2_IP=your-ec2-ip
```

7. Generate DNS records:
```bash
npm run generate-dns
```

## DNS Configuration

Add the following DNS records to your Vercel DNS settings:

1. A Record:
   - Name: mail.leazzy.in
   - Value: [Your AWS EC2 IP]
   - TTL: 3600

2. MX Record:
   - Name: @ (or leazzy.in)
   - Value: mail.leazzy.in
   - Priority: 10
   - TTL: 3600

3. SPF Record:
   - Name: @ (or leazzy.in)
   - Value: v=spf1 a mx ip4:[Your AWS EC2 IP] ~all
   - TTL: 3600

4. DMARC Record:
   - Name: _dmarc.leazzy.in
   - Value: v=DMARC1; p=none; rua=mailto:dmarc@leazzy.in
   - TTL: 3600

5. DKIM Record:
   - Name: default._domainkey.leazzy.in
   - Value: [Generated by the generate-dkim script]
   - TTL: 3600

## Production Deployment

1. Update the .env file to production mode:
```
NODE_ENV=production
```

2. Start the server in production mode:
```bash
npm run prod
```

3. The server will now use TLS encryption and DKIM signing.

## Testing

1. Test sending an email:
```bash
npm test
```

2. Check the logs:
```bash
tail -f logs/combined.log
```

3. Verify DNS records:
```bash
dig MX leazzy.in
dig TXT leazzy.in
dig TXT _dmarc.leazzy.in
dig TXT default._domainkey.leazzy.in
```

## Troubleshooting

1. If emails are not being received:
   - Check the logs for errors
   - Verify DNS records are correctly configured
   - Ensure port 25 is open on your EC2 instance

2. If DKIM signing is not working:
   - Verify the private key is correctly loaded
   - Check the DKIM DNS record is correctly configured

3. If TLS is not working:
   - Verify the SSL certificates are correctly installed
   - Check the certificate paths in the .env file

4. If MongoDB connection fails:
   - Verify the MongoDB URI is correct
   - Check if your IP address is whitelisted in MongoDB Atlas
   - Ensure the MongoDB user has the correct permissions 